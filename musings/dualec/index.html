<!DOCTYPE html><html lang=en><meta http-equiv=Content-Type content="text/html;charset=utf-8"> <meta http-equiv=X-UA-Compatible content="IE=edge"> <meta name=viewport content="width=device-width, initial-scale=1"><title>Why didn't NSA notice when their backdoor stopped working?</title><meta name=description content="The US National Security Agency’s backdoored pseudo random generator, Dual_EC_DRBG, being subverted in Juniper Network’s NetScreen is devices back in the new..."> <link rel=canonical href=https://checkoway.net/musings/dualec/> <link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css integrity=sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei crossorigin=anonymous> <link rel=stylesheet href=/css/main.css><main><article class=post vocab=http://schema.org typeof=BlogPosting><div class=post-header><img class=post-hero src=/assets/posts/dualec/SSG500M.jpg alt="Juniper SSG 500M"><h1 class=post-title property=headline>Why didn’t NSA notice when their backdoor stopped working?</h1><p class=post-meta><time datetime=2021-09-04T00:00:00+00:00 property=datePublished>Sep 4, 2021</time> • <span property=author typeof=Person><span property=name>Stephen Checkoway</span></span></div><div class=post-content property=articleBody><p>The US National Security Agency’s backdoored pseudo random generator, Dual_EC_DRBG, being subverted in Juniper Network’s NetScreen is devices back in the <a href=https://www.bloomberg.com/news/features/2021-09-02/juniper-mystery-attacks-traced-to-pentagon-role-and-chinese-hackers>news</a> again. In brief, Bloomberg is reporting that Chinese state-sponsored hackers were responsible for inserting code in Juniper’s ScreenOS operating system which rekeyed an existing backdoor which allowed passive decryption of network traffic and installing a separate backdoor which allowed administrator access to the devices running ScreenOS.<p>This has <a href=https://twitter.com/0xtyro/status/1433524755404103682>raised</a> the <a href=https://twitter.com/stevesmoot/status/1433534796223836174>question</a>, how long did it take the NSA to notice that their backdoor no longer worked and did they report this to Juniper? I don’t know the answer to those questions, but I think the most plausible explanation given by <a href=https://twitter.com/bascule/status/1433527218525900802>Tony Arcieri</a> and <a href=https://twitter.com/matthew_d_green/status/1433527716553297924>Matthew Green</a> is that the NSA did notice that their access degraded over time as targets upgraded their ScreenOS to newer versions. Nevertheless, I think there are other possible explanations, not all of which I’ve seen discussed so far.<p>I’m going to start with a <em>very</em> brief explanation of Dual EC.<sup id=fnref:1><a href=#fn:1 class=footnote rel=footnote role=doc-noteref>1</a></sup> Then, I’ll give some background on how ScreenOS uses Dual EC. And finally, I’ll give a list of possibilities. For more details on the history of Dual EC, I recommend giving Matt’s <a href=https://twitter.com/matthew_d_green/status/1433470109742518273>Twitter thread</a> a read.<h2 id=dual-ec-background>Dual EC background</h2><p>Dual EC is a “deterministic random bit generator” which means that starting with a small seed value, it can produce a stream of pseudorandom bits. Dual EC is a little unusual in that it uses public key cryptography to generate the output. It has two parameters <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>P</mi></mrow><annotation encoding=application/x-tex>P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.68333em;vertical-align:0em></span><span class=base><span class="mord mathit" style=margin-right:0.13889em>P</span></span></span></span> and <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span> which are points on an <a href=https://en.wikipedia.org/wiki/Elliptic_curve#Elliptic_curves_over_finite_fields>elliptic curve</a>. <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>P</mi></mrow><annotation encoding=application/x-tex>P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.68333em;vertical-align:0em></span><span class=base><span class="mord mathit" style=margin-right:0.13889em>P</span></span></span></span> generates a group under the elliptic curve <a href=https://en.wikipedia.org/wiki/Elliptic_curve#The_group_law>addition law</a> and <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span> is a member of that group. In order to come up with the point <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span>, the NSA (almost certainly) picked a large random number <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>e</mi></mrow><annotation encoding=application/x-tex>e</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.43056em;vertical-align:0em></span><span class=base><span class="mord mathit">e</span></span></span></span> and computed <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi><mo>=</mo><mi>e</mi><mi>P</mi></mrow><annotation encoding=application/x-tex>Q = eP</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class=mrel>=</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class="mord mathit">e</span><span class="mord mathit" style=margin-right:0.13889em>P</span></span></span></span>. It’s essential for <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>e</mi></mrow><annotation encoding=application/x-tex>e</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.43056em;vertical-align:0em></span><span class=base><span class="mord mathit">e</span></span></span></span> to remain secret because <strong>anyone who knows <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>e</mi></mrow><annotation encoding=application/x-tex>e</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.43056em;vertical-align:0em></span><span class=base><span class="mord mathit">e</span></span></span></span> and can see output from Dual EC can recover its internal state and then predict all future outputs</strong>. For more detail, see our paper on <a href=https://checkoway.net/papers/dualec2014/dualec2014.pdf>exploiting Dual EC in TLS</a>.<p>Whenever someone speaks of picking a <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span> value, this is the process they mean: pick a big random number and multiply <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>P</mi></mrow><annotation encoding=application/x-tex>P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.68333em;vertical-align:0em></span><span class=base><span class="mord mathit" style=margin-right:0.13889em>P</span></span></span></span> by it.<p>Dual EC is described as an NSA backdoor because the NSA generated <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>e</mi></mrow><annotation encoding=application/x-tex>e</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.43056em;vertical-align:0em></span><span class=base><span class="mord mathit">e</span></span></span></span> and thus can learn the generator’s internal state if they can see its output. Why is that a big deal? Well, lots of crypto algorithms depend on secret or unpredictable numbers. For example, if I know what bits your pseudorandom generator (PRG) is going to spit out and you use that PRG to generate a <a href=https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange>Diffie–Hellman</a> secret, then I know the secret value and can decrypt any network traffic protected by the result of the Diffie–Hellman key exchange.<h2 id=dual-ec-in-screenos>Dual EC in ScreenOS</h2><p>That brings us to Dual EC’s use in Juniper’s ScreenOS. As described in Bloomberg’s reporting, the US government insisted that Juniper use Dual EC in ScreenOS. Dual EC is used as part of a cascade of PRGs where Dual EC is supposed to generate the seed for the <a href=https://web.archive.org/web/20150905102112/http://csrc.nist.gov/groups/STM/cavp/documents/rng/931rngext.pdf>ANSI X9.31 PRG</a>. The output of X9.31 was supposed to be used for for generating random bits for things like Diffie–Hellman key exchange and nonces. However, this doesn’t happen. When Dual EC was introduced into ScreenOS, a collection of other suspicious changes happened at the same time<sup id=fnref:2><a href=#fn:2 class=footnote rel=footnote role=doc-noteref>2</a></sup> which results in X9.31 never being used and the output of Dual EC being used directly and in an exploitable manner. Juniper has not said why any of these changes were made and the recent reporting doesn’t make clear if any of them other than the introduction of Dual EC were requested by the US government.<p>ScreenOS uses <a href=https://en.wikipedia.org/wiki/Internet_Key_Exchange>Internet Key Exchange</a> (IKE) to generate ephemeral traffic keys for its VPN. Decrypting VPN traffic depends on the version of IKE used and the mode in which it is used. IKEv2 is always vulnerable to the passive decryption attack. IKEv1 is more complicated.<p>IKEv1 has four authentication modes, a digital signature mode, a preshared keys mode, and two public key encryption modes. The digital signature mode is always vulnerable to the passive decryption attack. The preshared key mode is vulnerable, but only if the preshared key is known to the attacker.<sup id=fnref:3><a href=#fn:3 class=footnote rel=footnote role=doc-noteref>3</a></sup> The two encryption modes are not vulnerable to this attack.<p>Finally, the <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span> value used in ScreenOS is <em>not</em> the value specified by the NSA. Instead, Juniper picked their own value of <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span>.<h2 id=some-possible-answers>Some possible answers</h2><p>This brings us to the question: Why didn’t the NSA notice that they had lost their backdoor? Here are some possibilities, in no particular order.<ul><li><p>The NSA probably did notice that they lost the ability to decrypt some of their targets’ traffic, and likely more over time. It likely depends on how quickly the firmware was updated after the attack.<li><p>The NSA never had the capability to decrypt ScreenOS VPN traffic because they didn’t know the secret key <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>e</mi></mrow><annotation encoding=application/x-tex>e</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.43056em;vertical-align:0em></span><span class=base><span class="mord mathit">e</span></span></span></span> such that <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi><mo>=</mo><mi>e</mi><mi>P</mi></mrow><annotation encoding=application/x-tex>Q = eP</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class=mrel>=</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class="mord mathit">e</span><span class="mord mathit" style=margin-right:0.13889em>P</span></span></span></span> for Juniper’s choice of <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span>.<p>In fact, it’s entirely possible that Juniper selected their <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span> value is a completely safe way: You generate a 32-byte random number <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>x</mi></mrow><annotation encoding=application/x-tex>x</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.43056em;vertical-align:0em></span><span class=base><span class="mord mathit">x</span></span></span></span> then you use the curve equation <span class=katex><span class=katex-mathml><math><semantics><mrow><msup><mi>y</mi><mn>2</mn></msup><mo>=</mo><msup><mi>x</mi><mn>3</mn></msup><mo>−</mo><mn>3</mn><mi>x</mi><mo>+</mo><mi>b</mi><mo><mo>(</mo><mo>mod</mo><mspace width=0.333333em></mspace><mi>p</mi><mo>)</mo></mo></mrow><annotation encoding=application/x-tex>y^2 = x^3 - 3x + b\pmod p</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.8141079999999999em></span><span class="strut bottom" style=height:1.064108em;vertical-align:-0.25em></span><span class=base><span class=mord><span class="mord mathit" style=margin-right:0.03588em>y</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:0.8141079999999999em><span style=top:-3.063em;margin-right:0.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class=mrel>=</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class=mord><span class="mord mathit">x</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:0.8141079999999999em><span style=top:-3.063em;margin-right:0.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mord rule" style=margin-right:0.2222222222222222em></span><span class=mbin>−</span><span class="mord rule" style=margin-right:0.2222222222222222em></span><span class=mord>3</span><span class="mord mathit">x</span><span class="mord rule" style=margin-right:0.2222222222222222em></span><span class=mbin>+</span><span class="mord rule" style=margin-right:0.2222222222222222em></span><span class="mord mathit">b</span><span class="mspace eightmuspace"></span>(mod<span class="mspace sixmuspace"></span><span class="mord mathit">p</span>)</span></span></span> (where <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>b</mi></mrow><annotation encoding=application/x-tex>b</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.69444em></span><span class="strut bottom" style=height:0.69444em;vertical-align:0em></span><span class=base><span class="mord mathit">b</span></span></span></span> is a large integer) to solve for <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>y</mi></mrow><annotation encoding=application/x-tex>y</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.625em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit" style=margin-right:0.03588em>y</span></span></span></span>. If you find a <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>y</mi></mrow><annotation encoding=application/x-tex>y</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.625em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit" style=margin-right:0.03588em>y</span></span></span></span> that works, then <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi><mo>=</mo><mo>(</mo><mi>x</mi><mo separator=true>,</mo><mi>y</mi><mo>)</mo></mrow><annotation encoding=application/x-tex>Q = (x, y)</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.75em></span><span class="strut bottom" style=height:1em;vertical-align:-0.25em></span><span class=base><span class="mord mathit">Q</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class=mrel>=</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class=mopen>(</span><span class="mord mathit">x</span><span class=mpunct>,</span><span class="mord rule" style=margin-right:0.16666666666666666em></span><span class="mord mathit" style=margin-right:0.03588em>y</span><span class=mclose>)</span></span></span></span> is your new point. (This is called point decompression and is fast to do.) If you do this, there is <em>some</em> <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>e</mi></mrow><annotation encoding=application/x-tex>e</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.43056em></span><span class="strut bottom" style=height:0.43056em;vertical-align:0em></span><span class=base><span class="mord mathit">e</span></span></span></span> such that <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi><mo>=</mo><mi>e</mi><mi>P</mi></mrow><annotation encoding=application/x-tex>Q=eP</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class=mrel>=</span><span class="mord rule" style=margin-right:0.2777777777777778em></span><span class="mord mathit">e</span><span class="mord mathit" style=margin-right:0.13889em>P</span></span></span></span>, but Juniper wouldn’t know what it is and it’s intractable to compute.<li><p>The NSA targets who updated their firmware to a version of ScreenOS with the Chinese (rather than US or Juniper) backdoor were using one of the modes of IKEv1 which defeat the passive decryption attack. There would be no way to detect that <span class=katex><span class=katex-mathml><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=application/x-tex>Q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=strut style=height:0.68333em></span><span class="strut bottom" style=height:0.8777699999999999em;vertical-align:-0.19444em></span><span class=base><span class="mord mathit">Q</span></span></span></span> had changed in this case.<li><p>The NSA targets disabled Dual EC entirely using an undocumented ScreenOS configuration command <code class="language-plaintext highlighter-rouge">set key one-stage-rng</code>. This actually exposes another security vulnerability that lets the X9.31 PRG be attacked, in some cases. See the end of Section 4 of <a href="https://checkoway.net/papers/juniper2016/juniper2016.pdf#page=4">our paper</a> about the Juniper breach for details.<p>I think this is highly unlikely as the command is not documented.<li><p>No high-value targets were using Juniper hardware with ScreenOS so the NSA simply wasn’t using this backdoor. I have no idea how plausible that is.<li><p>The NSA didn’t notice because they couldn’t see the traffic from their targets. I find this unlikely, but I have no actual knowledge.<li><p>Successfully carrying out the attack can be tricky depending on the network load. Because Dual EC is so slow, when it was added to ScreenOS, a queue of pre-generated nonce values was added, presumably to not slow down the connection. In fact, multiple queues were added, the number depends on the configuration and version of ScreenOS. See Section 5 of <a href="https://checkoway.net/papers/juniper2016/juniper2016.pdf#page=4">our paper</a>. A timer fires to generate a new nonce or a Diffie–Hellman key pair every second. With a large number of connections, you can end up with nonces generated after DH secret keys.<p>Depending on how often traffic key rekeying occurs, and depending on how that rekeying is configured, nonces can be consumed more quickly than DH key pairs leading to connections using fresh nonces and very old key pairs. This all makes the attack more difficult.</ul><p>I’m sure there are other possibilities I haven’t thought of. I’d love to hear about any I’ve missed.<hr><div class=footnotes role=doc-endnotes><ol><li id=fn:1><p>Dual_EC_DRBG is a pain to type, or say for that matter. I’m just going to call it Dual EC.&nbsp;<a href=#fnref:1 class=reversefootnote role=doc-backlink>↩</a><li id=fn:2><p>A bunch of changes happened all at once: Dual EC was introduced; reseeding changed from every 10,000 calls to the generator to every call; a loop variable was changed from local to global which caused Dual EC output to be used instead of X9.31 output; nonces were changed from 20 bytes to 32 bytes (the perfect size for a Dual EC backdoor); and a nonce pregeneration queue was added which makes it likely that nonces will be generated before Diffie–Hellman secret keys.&nbsp;<a href=#fnref:2 class=reversefootnote role=doc-backlink>↩</a><li id=fn:3><p>An attacker who can capture the network traffic and perform an offline attack on the preshared key.&nbsp;<a href=#fnref:3 class=reversefootnote role=doc-backlink>↩</a></ol></div></div><div class=post-footer><p class=post-meta>Last updated <time datetime=2021-09-04T00:00:00+00:00 property=dateModified>Sep 4, 2021</time>.</div></article></main>