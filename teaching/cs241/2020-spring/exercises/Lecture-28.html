<!DOCTYPE html><html lang=en><meta http-equiv=Content-Type content="text/html;charset=utf-8"> <meta http-equiv=X-UA-Compatible content="IE=edge"> <meta name=viewport content="width=device-width, initial-scale=1"><title>Lecture 28</title><meta name=description content="Lecture 28 – Apr 20th, 2020"> <link rel=canonical href=https://checkoway.net/teaching/cs241/2020-spring/exercises/Lecture-28.html> <link rel=stylesheet href=/css/main.css><main><h1 id=lecture-28--apr-20th-2020>Lecture 28 – Apr 20th, 2020</h1><h2 id=setup>Setup</h2><ol><li>Log in to clyde.<li>Copy <code class="language-plaintext highlighter-rouge">~steve/ex/sig</code> to your home directory.</ol><h2 id=task>Task</h2><ol><li><p><code class="language-plaintext highlighter-rouge">cd</code> into <code class="language-plaintext highlighter-rouge">sig</code> and look at <code class="language-plaintext highlighter-rouge">block.c</code>. It installs a signal handler for <code class="language-plaintext highlighter-rouge">SIGINT</code>, masks <code class="language-plaintext highlighter-rouge">SIGINT</code>, sleeps for three seconds, and then unmasks <code class="language-plaintext highlighter-rouge">SIGINT</code>.<p>Run <code class="language-plaintext highlighter-rouge">$ make</code> to compile <code class="language-plaintext highlighter-rouge">block</code>. Run <code class="language-plaintext highlighter-rouge">$ ./block</code> and let it sit until it exits. Nothing should be printed.<p>Run it again, but this time, press <code class="language-plaintext highlighter-rouge">ctrl-C</code> a few times while it is sleeping. See how many times the message printed from the signal handler happens. (Note that although we cannot use <code class="language-plaintext highlighter-rouge">printf(3)</code> from a signal handler, we <em>can</em> use <code class="language-plaintext highlighter-rouge">write(2)</code>.)<li><p>Now, take a look at <code class="language-plaintext highlighter-rouge">sig.c</code>. Modify the code such that when <code class="language-plaintext highlighter-rouge">ctrl-C</code> is pressed, <code class="language-plaintext highlighter-rouge">interrupt_count</code> is incremented and when <code class="language-plaintext highlighter-rouge">ctrl-\</code> is pressed (which sends <code class="language-plaintext highlighter-rouge">SIGQUIT</code>), <code class="language-plaintext highlighter-rouge">done</code> is set to <code class="language-plaintext highlighter-rouge">1</code> to exit the loop. Make sure to uncomment the loop.<p>To do this, you’ll need to use <code class="language-plaintext highlighter-rouge">sigaction(2)</code> twice to install a signal handler for <code class="language-plaintext highlighter-rouge">SIGINT</code> and <code class="language-plaintext highlighter-rouge">SIGQUIT</code>. You can use the same function or two different functions. I suggest copying the relevant code from <code class="language-plaintext highlighter-rouge">block.c</code>.<li>Build and run <code class="language-plaintext highlighter-rouge">./sig</code>. Try pressing <code class="language-plaintext highlighter-rouge">ctrl-C</code> a few times and then press <code class="language-plaintext highlighter-rouge">ctrl-\</code>. It should print the number of times you pressed <code class="language-plaintext highlighter-rouge">ctrl-C</code>.<li>Run <code class="language-plaintext highlighter-rouge">./block</code> in a short loop <div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>$ for i in {1..3}; do ./block; done
</code></pre></div></div><p>and press <code class="language-plaintext highlighter-rouge">ctrl-C</code> while it is running.<p>You’ll notice that after <code class="language-plaintext highlighter-rouge">SIGINT</code> is unmasked and the program exits, the <code class="language-plaintext highlighter-rouge">for</code> loop keeps running and <code class="language-plaintext highlighter-rouge">block</code> will be run again. This is because the signal handler caught and handled the signal so Bash didn’t know that it had exited due to a signal.<li><p>Change the <code class="language-plaintext highlighter-rouge">sa_flags</code> to be <code class="language-plaintext highlighter-rouge">SA_RESTART | SA_RESETHAND</code>. This will reset the signal handler to the default behavior as soon as the signal is delivered to the handler.<p>Add <code class="language-plaintext highlighter-rouge">raise(sig)</code> at the end of the handler to raise the signal again.<p>Rerun the loop from part 4 above and press <code class="language-plaintext highlighter-rouge">ctrl-C</code>. This time, it should exit immediately.</ol></main>