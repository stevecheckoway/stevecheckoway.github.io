<!DOCTYPE html><html lang=en><meta http-equiv=Content-Type content="text/html;charset=utf-8"> <meta http-equiv=X-UA-Compatible content="IE=edge"> <meta name=viewport content="width=device-width, initial-scale=1"><title>Lecture 16</title><meta name=description content="Lecture 16 – Mar 9th, 2020"> <link rel=canonical href=https://checkoway.net/teaching/cs241/2020-spring/exercises/Lecture-16.html> <link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css integrity=sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei crossorigin=anonymous> <link rel=stylesheet href=/css/main.css><main><h1 id=lecture-16--mar-9th-2020>Lecture 16 – Mar 9th, 2020</h1><h2 id=setup>Setup</h2><ol><li>Log in to clyde.<li>Create a directory and <code class="language-plaintext highlighter-rouge">cd</code> into it.<li>Copy <code class="language-plaintext highlighter-rouge">~steve/ex/arr.c</code> into the directory.</ol><h2 id=task>Task</h2><ol><li>Look at the code for <code class="language-plaintext highlighter-rouge">arr.c</code>. It currently doesn’t do much more than look at its command line parameters. Compile the program and run it with a positive number, a negative number, 0, and something that isn’t a number but starts with a number like <code class="language-plaintext highlighter-rouge">35foo</code>.<li>Inside <code class="language-plaintext highlighter-rouge">main</code>, create a variable-length array, <code class="language-plaintext highlighter-rouge">seq</code>, of <code class="language-plaintext highlighter-rouge">int</code>s of size <code class="language-plaintext highlighter-rouge">n</code>. Initialize this array using a <code class="language-plaintext highlighter-rouge">for</code> loop such <code class="language-plaintext highlighter-rouge">seq[idx]</code> has the value <code class="language-plaintext highlighter-rouge">idx*idx</code> if <code class="language-plaintext highlighter-rouge">idx</code> is even and <code class="language-plaintext highlighter-rouge">-idx*idx</code> if <code class="language-plaintext highlighter-rouge">idx</code> is odd.<li>Write a function <div class="language-c highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=kt>int</span> <span class=nf>sum</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>len</span><span class=p>,</span> <span class=kt>int</span> <span class=n>arr</span><span class=p>[</span><span class=n>len</span><span class=p>]);</span>
</code></pre></div></div><p>that computes and returns the sum of the elements of <code class="language-plaintext highlighter-rouge">arr</code>.<p>Inside <code class="language-plaintext highlighter-rouge">main</code>, print out the result of <code class="language-plaintext highlighter-rouge">sum(n, seq)</code>.<p>Compile and run the code with a few small values of the command line argument <code class="language-plaintext highlighter-rouge">NUM</code>. Make sure you compile with<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>$ clang -Wall -std=c11 -o arr arr.c
</code></pre></div></div><p>and fix any warnings that appear.<li>Change the code to print out <code class="language-plaintext highlighter-rouge">sum(n+10, seq)</code> instead. Before you compile and run this, make a prediction as to what will happen? Now compile and run. Did it match your expectation?<li><p>In task 4, the code was changed so that the <code class="language-plaintext highlighter-rouge">sum</code> function would read beyond the end of the array. The compiler didn’t complain about this. At runtime, you got strange results, but there was no error or warning.<p><strong>This is bad. Nearly every C program in existence has a similar problem.</strong><p>Compile your program with<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>$ clang -Wall -std=c11 -fsanitize=address,undefined -o arr arr.c
</code></pre></div></div><p>and run it again. This time it should crash with a colorful error message. This additional option tells the compiler (and the linker) to insert additional code in the program to detect these sorts of undefined behavior.<li><p>You can get a nice backtrace (a list of the functions that were called leading to the error) with a couple of more steps.<p>Compile with<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>$ clang -Wall -std=c11 -fsanitize=address,undefined -g -o arr arr.c
</code></pre></div></div><p>where the additional <code class="language-plaintext highlighter-rouge">-g</code> option adds debugging information to the binary. Run the program with a particular environment variable set.<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>$ ASAN_SYMBOLIZER_PATH=/usr/lib/llvm-6.0/bin/llvm-symbolizer ./arr 8
</code></pre></div></div><p>When I do that, I get the output<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>==7410==ERROR: AddressSanitizer: dynamic-stack-buffer-overflow on address 0x7ffd4d3aee80 at pc 0x00000051222d bp 0x7ffd4d3aedd0 sp 0x7ffd4d3aedc8
READ of size 4 at 0x7ffd4d3aee80 thread T0
 #0 0x51222c in sum /usr/users/noquota/faculty/steve/inclass/arr.c:8:14
 #1 0x5128f8 in main /usr/users/noquota/faculty/steve/inclass/arr.c:25:18
 #2 0x7f7ab6782b96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
 #3 0x419d59 in _start (/net/storage/zfs/faculty/steve/inclass/arr+0x419d59)
</code></pre></div></div><p>where this is telling me that the error happened in <code class="language-plaintext highlighter-rouge">arr.c</code> in the <code class="language-plaintext highlighter-rouge">sum</code> function on line 8, column 14. It also shows where <code class="language-plaintext highlighter-rouge">sum</code> was called from, namely <code class="language-plaintext highlighter-rouge">main</code> at line 25, column 18.<li>Write a program to concatenate all command line arguments into a single string separated by spaces. I.e., you want something like <div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>int main(int argc, char *argv[argc]) {
  char msg[] = "You ran the following command:";
  char command_line[50];
  /* copy argv[0] to command_line */
  for (int i = 1; i &lt; argc; ++i) {
    /* append a space to command_line */
    /* append argv[i] to command_line */
  }
  puts(msg);
  puts(command_line);
  return 0;
}
</code></pre></div></div><p>Use <code class="language-plaintext highlighter-rouge">strcpy(3)</code> and <code class="language-plaintext highlighter-rouge">strcat(3)</code> to perform the copies.<p>Run the program with slightly more than 50 characters of command line arguments. What happens? Recompile with <code class="language-plaintext highlighter-rouge">-fsanitize=address,undefined</code> and run the program again.<li>Modify the program to use <code class="language-plaintext highlighter-rouge">strlcpy(3)</code> and <code class="language-plaintext highlighter-rouge">strlcat(3)</code> instead. Recompile with <code class="language-plaintext highlighter-rouge">-fsanitize=address,undefined</code> and see what happens.</ol></main>