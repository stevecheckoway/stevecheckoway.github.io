<!DOCTYPE html><html lang=en><meta http-equiv=Content-Type content="text/html;charset=utf-8"> <meta http-equiv=X-UA-Compatible content="IE=edge"> <meta name=viewport content="width=device-width, initial-scale=1"><title>Lecture 26</title><meta name=description content="Lecture 26 – Apr 15th, 2020"> <link rel=canonical href=https://checkoway.net/teaching/cs241/2020-spring/exercises/Lecture-26.html> <link rel=stylesheet href=/css/main.css><main><h1 id=lecture-26--apr-15th-2020>Lecture 26 – Apr 15th, 2020</h1><h2 id=setup>Setup</h2><ol><li>Log in to clyde.<li>Copy <code class="language-plaintext highlighter-rouge">~steve/ex/checksum</code> to your home directory</ol><h2 id=task>Task</h2><ol><li>Write a function in C to compute a 1-byte checksum of a file. Look in <code class="language-plaintext highlighter-rouge">checksum.c</code>. You’ll need to modify the function to <ol><li>Open the file with <code class="language-plaintext highlighter-rouge">open(2)</code>;<li>In a loop, read the file one byte at a time using <code class="language-plaintext highlighter-rouge">read(2)</code> into the variable <code class="language-plaintext highlighter-rouge">byte</code> and add that value to <code class="language-plaintext highlighter-rouge">cs</code>;<li>Close the file descriptor using <code class="language-plaintext highlighter-rouge">close(2)</code>; and<li>Return <code class="language-plaintext highlighter-rouge">256 - cs</code>.</ol><p>If step 1 fails, return <code class="language-plaintext highlighter-rouge">-1</code>. If step 2 fails, save <code class="language-plaintext highlighter-rouge">errno</code> into a local variable, call <code class="language-plaintext highlighter-rouge">close(2)</code> on the file descriptor, set <code class="language-plaintext highlighter-rouge">errno</code> back to the value it had before calling <code class="language-plaintext highlighter-rouge">close(2)</code>, and return -1. (If <code class="language-plaintext highlighter-rouge">close(2)</code> fails, there’s nothing we can do anyway, so don’t bother check its return value. But after class, you should read <a href=https://stackoverflow.com/a/24479705>this</a> about a case where failing to check the return of <code class="language-plaintext highlighter-rouge">close(2)</code> can actually lead to data corruption!)<p>Note that the return value of <code class="language-plaintext highlighter-rouge">read(2)</code> is a <code class="language-plaintext highlighter-rouge">ssize_t</code> which is like a <code class="language-plaintext highlighter-rouge">size_t</code> but is signed. So <code class="language-plaintext highlighter-rouge">read(2)</code> returns <code class="language-plaintext highlighter-rouge">-1</code> on error and <code class="language-plaintext highlighter-rouge">0</code> on <code class="language-plaintext highlighter-rouge">EOF</code>.<p>You should be able to run <code class="language-plaintext highlighter-rouge">checksum</code> on various files to get a simple 1-byte checksum.<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>$ ./checksum checksum checksum.c Makefile
47  checksum
f5  checksum.c
f8  Makefile
</code></pre></div></div><p>(You will almost certainly get different values for <code class="language-plaintext highlighter-rouge">checksum</code> and <code class="language-plaintext highlighter-rouge">checksum.c</code>, but the value for <code class="language-plaintext highlighter-rouge">Makefile</code> should be the same, unless you have modified it.)<li><p>In <code class="language-plaintext highlighter-rouge">checksum2.c</code>, you’re going to write the same program except you’re going to use <code class="language-plaintext highlighter-rouge">fopen(3)</code>, <code class="language-plaintext highlighter-rouge">fread(3)</code>, and <code class="language-plaintext highlighter-rouge">fclose(3)</code> instead of <code class="language-plaintext highlighter-rouge">open(2)</code>, <code class="language-plaintext highlighter-rouge">read(2)</code>, and <code class="language-plaintext highlighter-rouge">close(2)</code>.<p>One thing to notice is the file descriptor is the first argument to <code class="language-plaintext highlighter-rouge">read(2)</code> whereas the file pointer (<code class="language-plaintext highlighter-rouge">FILE *</code>) is the last argument to <code class="language-plaintext highlighter-rouge">fread(3)</code>.<p>In addition, <code class="language-plaintext highlighter-rouge">fread(3)</code> returns an unsigned <code class="language-plaintext highlighter-rouge">size_t</code> rather than a signed <code class="language-plaintext highlighter-rouge">ssize_t</code>. On failure, <code class="language-plaintext highlighter-rouge">fread(3)</code> returns <code class="language-plaintext highlighter-rouge">0</code>, just as it does for <code class="language-plaintext highlighter-rouge">EOF</code>. You should use <code class="language-plaintext highlighter-rouge">ferror(3)</code> to check if the <code class="language-plaintext highlighter-rouge">fread(3)</code> failed. If it did fail, save <code class="language-plaintext highlighter-rouge">errno</code>, call <code class="language-plaintext highlighter-rouge">fclose(3)</code>, restore <code class="language-plaintext highlighter-rouge">errno</code>, and return <code class="language-plaintext highlighter-rouge">-1</code>.<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>$ ./checksum checksum checksum.c checksum2 checksum2.c Makefile
47  checksum
f5  checksum.c
bb  checksum2
a3  checksum2.c
f8  Makefile
</code></pre></div></div><p>Again, your code and binaries will probably be different from mine, but you should get the same results with either <code class="language-plaintext highlighter-rouge">checksum</code> or <code class="language-plaintext highlighter-rouge">checksum2</code>.<li><p>You probably noticed that <code class="language-plaintext highlighter-rouge">checksum</code> took several seconds where as <code class="language-plaintext highlighter-rouge">checksum2</code> finished almost immediately.<p>Think about why that is and try to come up with an explanation. We’ll figure out why this happened next class.</ol></main>