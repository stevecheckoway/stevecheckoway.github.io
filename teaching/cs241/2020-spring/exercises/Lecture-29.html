<!DOCTYPE html><html lang=en><meta http-equiv=Content-Type content="text/html;charset=utf-8"> <meta http-equiv=X-UA-Compatible content="IE=edge"> <meta name=viewport content="width=device-width, initial-scale=1"><title>Lecture 29</title><meta name=description content="Lecture 29 – Apr 22nd, 2020"> <link rel=canonical href=https://checkoway.net/teaching/cs241/2020-spring/exercises/Lecture-29.html> <link rel=stylesheet href=/css/main.css><main><h1 id=lecture-29--apr-22nd-2020>Lecture 29 – Apr 22nd, 2020</h1><h2 id=setup>Setup</h2><ol><li>Log in to clyde.<li>Copy <code class=highlighter-rouge>~steve/ex/staticlib</code> to your home directory.</ol><h2 id=task>Task</h2><ol><li>First, look through all of the <code class=highlighter-rouge>.c</code> files.<li>Compile each of the <code class=highlighter-rouge>.c</code> files to <code class=highlighter-rouge>.o</code> file. You can either do this by hand <div class=highlighter-rouge><div class=highlight><pre class=highlight><code>$ clang -c -o a.o a.c
</code></pre></div></div><p>or you can use <code class=highlighter-rouge>make(1)</code>’s built-in rule.<div class=highlighter-rouge><div class=highlight><pre class=highlight><code>$ make CC=clang a.o b.o foo.o bar.o
</code></pre></div></div><li>Use <code class=highlighter-rouge>nm(1)</code> to print out the symbols for each of the <code class=highlighter-rouge>.o</code> files. <div class=highlighter-rouge><div class=highlight><pre class=highlight><code>$ nm *.o
</code></pre></div></div><p>This shows you the symbol name and, if it’s defined, the value. Undefined symbols show up as <code class=highlighter-rouge>U</code>. Defined global function symbols show up as <code class=highlighter-rouge>T</code> (for text). There are other possibilities listed in the man page for <code class=highlighter-rouge>nm(1)</code>.<li><p>Create an archive <code class=highlighter-rouge>libex.a</code> containing <code class=highlighter-rouge>a.o</code> and <code class=highlighter-rouge>b.o</code> using <code class=highlighter-rouge>ar(1)</code>. Either check the man page or look at the slides.<p><code class=highlighter-rouge>nm(1)</code> works with archives too. Try running it on <code class=highlighter-rouge>libex.a</code>. It should list the symbols for both <code class=highlighter-rouge>a.o</code> and <code class=highlighter-rouge>b.o</code>.<p>You might notice that one symbol in <code class=highlighter-rouge>a.o</code> and one in <code class=highlighter-rouge>b.o</code> have value 0. That’s because the archive just contains the two object files (and a symbol table assuming you used the <code class=highlighter-rouge>s</code> option to <code class=highlighter-rouge>ar(1)</code> <em>or</em> ran <code class=highlighter-rouge>$ ranlib libex.a</code>). Each object file is independent and the 0 is an offset into the <code class=highlighter-rouge>.text</code> segment of the corresponding file.<li><p>You can use <code class=highlighter-rouge>$ readelf -SW</code> to print out the list of sections in object files (including those in archives) (or any other sort of ELF file).<p>You can also get more information about the symbols by using <code class=highlighter-rouge>$ readelf -s</code>.<li>Create an archive <code class=highlighter-rouge>libbar.a</code> containing <code class=highlighter-rouge>bar.o</code>.<li>Now run <div class=highlighter-rouge><div class=highlight><pre class=highlight><code>$ clang -o prog1 foo.o libbar.a libex.a
</code></pre></div></div><p>Look at the included symbol using<div class=highlighter-rouge><div class=highlight><pre class=highlight><code>$ nm prog1|grep ' T '
</code></pre></div></div><p>(<code class=highlighter-rouge>nm(1)</code> has <code class=highlighter-rouge>-g</code> and <code class=highlighter-rouge>--defined-only</code> options that together are close to what you get from the <code class=highlighter-rouge>grep</code>, but they also include other data).<p>Can you tell which object files got included? If not, try running <code class=highlighter-rouge>$ ./prog1</code>.<li>Run <div class=highlighter-rouge><div class=highlight><pre class=highlight><code>$ clang -o prog2 foo.o libex.a libbar.a
</code></pre></div></div><p>and look at its defined symbols. Can you tell which object files got included? Are they they same ones from step 7?<p>Run <code class=highlighter-rouge>$ ./prog2</code> and compare the output with that of <code class=highlighter-rouge>$ ./prog1</code>.<li><p>Create a <code class=highlighter-rouge>Makefile</code> with targets <code class=highlighter-rouge>all</code>, <code class=highlighter-rouge>clean</code>, <code class=highlighter-rouge>prog1</code>, <code class=highlighter-rouge>prog2</code>, <code class=highlighter-rouge>libex.a</code>, and <code class=highlighter-rouge>libbar.a</code> that build <code class=highlighter-rouge>prog1</code> and <code class=highlighter-rouge>prog2</code> as specified above.<p>Make sure <code class=highlighter-rouge>all</code> and <code class=highlighter-rouge>clean</code> are <code class=highlighter-rouge>.PHONY</code> targets and that all of the object files depend on <code class=highlighter-rouge>ex.h</code>.<p>Don’t forget to <code class=highlighter-rouge>$(RM) $@</code> before building an archive.</ol></main>